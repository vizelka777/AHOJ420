{{define "layout"}}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{.Title}}</title>
  <style>
    :root {
      --bg: #f5f7fb;
      --surface: #ffffff;
      --text: #102131;
      --muted: #5f7287;
      --border: #d6dee8;
      --accent: #1259b3;
      --ok: #0a7f3f;
      --warn: #9b1c1c;
      --chip-bg: #edf3fb;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: "Segoe UI", "Helvetica Neue", Helvetica, Arial, sans-serif;
      line-height: 1.4;
    }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }
    .container { max-width: 1120px; margin: 0 auto; padding: 20px; }
    .top {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
    }
    .top-inner {
      max-width: 1120px;
      margin: 0 auto;
      padding: 14px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .menu { display: flex; align-items: center; gap: 14px; }
    .user { color: var(--muted); font-size: 14px; }
    .panel {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .row { display: flex; flex-wrap: wrap; gap: 12px; }
    .row > * { flex: 1 1 220px; }
    label { display: block; font-weight: 600; margin-bottom: 6px; }
    input[type=text],
    input[type=password],
    textarea,
    select {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px;
      font-size: 14px;
      background: #fff;
      color: var(--text);
    }
    textarea { min-height: 110px; resize: vertical; font-family: ui-monospace, Menlo, Monaco, Consolas, monospace; }
    .actions { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 14px; }
    button,
    .btn {
      background: var(--accent);
      border: 1px solid var(--accent);
      color: #fff;
      border-radius: 8px;
      padding: 9px 14px;
      font-size: 14px;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
    }
    .btn.secondary,
    button.secondary {
      background: #fff;
      color: var(--text);
      border-color: var(--border);
    }
    .btn.warn,
    button.warn {
      background: #fff3f3;
      color: var(--warn);
      border-color: #eab8b8;
    }
    .flash {
      border-radius: 8px;
      padding: 10px 12px;
      margin-bottom: 14px;
      border: 1px solid var(--border);
      background: #edf3fb;
    }
    .flash.success {
      background: #ebf8f0;
      color: var(--ok);
      border-color: #bfe3cc;
    }
    .flash.error {
      background: #fff0f0;
      color: var(--warn);
      border-color: #f0c2c2;
    }
    .error {
      border: 1px solid #f0c2c2;
      background: #fff0f0;
      color: var(--warn);
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 12px;
    }
    .table-wrap { overflow-x: auto; }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      background: #fff;
    }
    th, td {
      text-align: left;
      padding: 10px;
      border-bottom: 1px solid var(--border);
      vertical-align: top;
    }
    th { color: var(--muted); font-weight: 600; }
    .mono { font-family: ui-monospace, Menlo, Monaco, Consolas, monospace; }
    .chips { display: flex; flex-wrap: wrap; gap: 6px; }
    .chip {
      display: inline-block;
      border: 1px solid var(--border);
      background: var(--chip-bg);
      color: var(--text);
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 12px;
      font-weight: 600;
    }
    .chip.ok { background: #ebf8f0; border-color: #bfe3cc; color: var(--ok); }
    .chip.warn { background: #fff0f0; border-color: #f0c2c2; color: var(--warn); }
    .hint { color: var(--muted); font-size: 13px; margin-top: 6px; }
    .grid2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px; }
    .kv { margin: 0; }
    .kv dt { color: var(--muted); font-size: 12px; text-transform: uppercase; margin-bottom: 4px; }
    .kv dd { margin: 0 0 12px 0; font-weight: 600; }
    .stack { display: flex; flex-direction: column; gap: 12px; }
    @media (max-width: 700px) {
      .top-inner { flex-direction: column; align-items: flex-start; }
      .container { padding: 14px; }
    }
  </style>
</head>
<body>
  <header class="top">
    <div class="top-inner">
      <div class="menu">
        <a href="/admin/"><strong>AHOJ420 Admin</strong></a>
        {{if .Admin}}
          <a href="/admin/">Overview</a>
          <a href="/admin/clients">Clients</a>
          <a href="/admin/audit">Audit log</a>
          <a href="/admin/security">Security</a>
        {{end}}
      </div>
      {{if .Admin}}
      <div class="menu">
        <span class="user">{{if .Admin.DisplayName}}{{.Admin.DisplayName}}{{else}}{{.Admin.Login}}{{end}}</span>
        <form method="post" action="/admin/logout" style="margin:0;">
          <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
          <button type="submit" class="secondary">Logout</button>
        </form>
      </div>
      {{end}}
    </div>
  </header>

  <main class="container">
    {{if .Flash}}
      <div class="flash {{.Flash.Kind}}">{{.Flash.Message}}</div>
    {{end}}
    {{template "content" .}}
  </main>

  <script>
  (function () {
    var fallbackTTLSeconds = 300;
    var ttlFromServer = Number("{{.ReauthTTLSeconds}}");
    if (!Number.isFinite(ttlFromServer) || ttlFromServer <= 0) {
      ttlFromServer = fallbackTTLSeconds;
    }
    var reauthWindowMs = ttlFromServer * 1000;
    var lastReauthAtMs = 0;

    function isTruthy(value) {
      var normalized = String(value || "").toLowerCase().trim();
      return normalized === "1" || normalized === "true" || normalized === "yes" || normalized === "on";
    }

    function b64uToBytes(value) {
      var padded = value + "=".repeat((4 - (value.length % 4)) % 4);
      var base64 = padded.replace(/-/g, "+").replace(/_/g, "/");
      var bin = atob(base64);
      return Uint8Array.from(bin, function (ch) { return ch.charCodeAt(0); });
    }

    function bytesToB64u(buffer) {
      var bytes = new Uint8Array(buffer);
      var bin = "";
      for (var i = 0; i < bytes.length; i += 1) {
        bin += String.fromCharCode(bytes[i]);
      }
      return btoa(bin).replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/g, "");
    }

    function extractErrorMessage(error, fallbackMessage) {
      if (error && error.message) {
        return String(error.message);
      }
      return fallbackMessage;
    }

    async function beginReauth() {
      var res = await fetch("/admin/auth/reauth/begin", {
        method: "POST",
        credentials: "include",
        headers: { "X-Admin-Reauth-Flow": "1" }
      });
      if (!res.ok) {
        var message = "Unable to start admin re-authentication";
        try {
          var payload = await res.json();
          if (payload && payload.message) {
            message = payload.message;
          }
        } catch (_) {}
        throw new Error(message);
      }
      var data = await res.json();
      return data.publicKey || data;
    }

    async function finishReauth(assertion) {
      var body = {
        id: assertion.id,
        type: assertion.type,
        rawId: bytesToB64u(assertion.rawId),
        response: {
          authenticatorData: bytesToB64u(assertion.response.authenticatorData),
          clientDataJSON: bytesToB64u(assertion.response.clientDataJSON),
          signature: bytesToB64u(assertion.response.signature),
          userHandle: assertion.response.userHandle ? bytesToB64u(assertion.response.userHandle) : ""
        }
      };

      var res = await fetch("/admin/auth/reauth/finish", {
        method: "POST",
        credentials: "include",
        headers: {
          "Content-Type": "application/json",
          "X-Admin-Reauth-Flow": "1"
        },
        body: JSON.stringify(body)
      });
      if (!res.ok) {
        var message = "Admin re-authentication failed";
        try {
          var payload = await res.json();
          if (payload && payload.message) {
            message = payload.message;
          }
        } catch (_) {}
        throw new Error(message);
      }
    }

    async function runReauth() {
      if (typeof PublicKeyCredential === "undefined" || !navigator.credentials || !navigator.credentials.get) {
        throw new Error("WebAuthn is not available in this browser");
      }

      var publicKey = await beginReauth();
      publicKey.challenge = b64uToBytes(publicKey.challenge);
      if (publicKey.allowCredentials) {
        publicKey.allowCredentials = publicKey.allowCredentials.map(function (item) {
          return Object.assign({}, item, { id: b64uToBytes(item.id) });
        });
      }

      var assertion = await navigator.credentials.get({ publicKey: publicKey });
      if (!assertion) {
        throw new Error("No passkey assertion returned");
      }
      await finishReauth(assertion);
      lastReauthAtMs = Date.now();
    }

    function shouldRequireReauth(form) {
      if (!form || !form.dataset) {
        return false;
      }
      if (!isTruthy(form.dataset.requireReauth)) {
        return false;
      }
      var check = (form.dataset.reauthCheck || "").trim();
      if (check === "") {
        return true;
      }
      if (check === "create-confidential-client") {
        var confidentialSelect = form.querySelector('select[name="confidential"]');
        return confidentialSelect ? isTruthy(confidentialSelect.value) : true;
      }
      if (check === "disable-client") {
        var wasEnabled = isTruthy(form.dataset.clientEnabled);
        if (!wasEnabled) {
          return false;
        }
        var enabledInput = form.querySelector('input[name="enabled"]');
        var enabledNow = enabledInput ? !!enabledInput.checked : false;
        return !enabledNow;
      }
      if (check === "logout-other-session") {
        return !isTruthy(form.dataset.sessionCurrent);
      }
      return true;
    }

    function setFormSubmitting(form, isSubmitting) {
      var buttons = form.querySelectorAll('button[type="submit"], input[type="submit"]');
      for (var i = 0; i < buttons.length; i += 1) {
        buttons[i].disabled = !!isSubmitting;
      }
    }

    document.addEventListener("submit", function (event) {
      var form = event.target;
      if (!(form instanceof HTMLFormElement)) {
        return;
      }
      if (!shouldRequireReauth(form)) {
        return;
      }
      if (form.dataset.reauthInProgress === "1") {
        event.preventDefault();
        return;
      }

      event.preventDefault();
      form.dataset.reauthInProgress = "1";
      setFormSubmitting(form, true);

      if (lastReauthAtMs > 0 && Date.now() - lastReauthAtMs < reauthWindowMs) {
        setFormSubmitting(form, false);
        delete form.dataset.reauthInProgress;
        form.submit();
        return;
      }

      runReauth().then(function () {
        setFormSubmitting(form, false);
        delete form.dataset.reauthInProgress;
        form.submit();
      }).catch(function (err) {
        setFormSubmitting(form, false);
        delete form.dataset.reauthInProgress;
        window.alert(extractErrorMessage(err, "Recent admin re-authentication is required"));
      });
    }, true);

    window.adminRunReauth = runReauth;
  })();
  </script>
</body>
</html>
{{end}}
