<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ahoj420 - Passkey Auth</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/static/js/glue.js?v=20260127b"></script>
    <style>
        #profile-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.65);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
            z-index: 50;
        }
        #profile-modal.open {
            display: flex;
        }
    </style>
</head>

<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center font-sans">

    <div class="bg-gray-800 p-8 rounded-2xl shadow-xl w-full max-w-md border border-gray-700">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-teal-400 to-blue-500">
                Ahoj420
            </h1>
            <p class="text-gray-400 mt-2">The Passwordless Future</p>
        </div>

        <div id="guest-ui">
            <!-- Tabs -->
            <div class="flex border-b border-gray-700 mb-6">
                <button onclick="switchMode('login')" id="tab-login"
                    class="flex-1 py-2 text-blue-400 border-b-2 border-blue-400 font-medium">Sign In</button>
                <button onclick="switchMode('register')" id="tab-register" class="flex-1 py-2 text-gray-500 font-medium">
                    Register</button>
            </div>

            <!-- Registration Form -->
            <div id="register-flow" class="hidden">
                <h2 class="text-xl font-semibold mb-4 text-center">Create Passkey</h2>
                <form class="space-y-4" onsubmit="handleRegister(event)">
                    <button type="submit"
                        class="w-full py-3 bg-gradient-to-r from-teal-500 to-blue-600 rounded-lg font-semibold hover:from-teal-400 hover:to-blue-500 transition shadow-lg shadow-teal-500/20">
                        Create Passkey
                    </button>
                </form>
            </div>

            <!-- Login Form -->
            <div id="login-flow">
                <h2 class="text-xl font-semibold mb-4 text-center">Welcome Back</h2>
                <form class="space-y-4" onsubmit="handleLogin(event)">
                    <button type="submit"
                        class="w-full py-3 bg-gradient-to-r from-blue-600 to-purple-600 rounded-lg font-semibold hover:from-blue-500 hover:to-purple-500 transition shadow-lg shadow-blue-500/20">
                        Sign In with Passkey
                    </button>
                </form>
            </div>

            <!-- Extra options -->
            <div class="mt-6 space-y-3">
                <button class="w-full py-2 text-sm border border-gray-600 rounded-lg text-gray-300 hover:text-white hover:border-gray-400 transition" disabled>
                    QR Login (coming soon)
                </button>
                <button class="w-full py-2 text-sm border border-gray-600 rounded-lg text-gray-300 hover:text-white hover:border-gray-400 transition" disabled>
                    Add Device (coming soon)
                </button>
            </div>
        </div>

        <div id="account-ui" class="hidden space-y-4">
            <h2 class="text-xl font-semibold text-center">Ваш профиль</h2>
            <div class="flex items-center gap-3">
                <img id="account-avatar" src="" alt="Avatar"
                    class="w-16 h-16 rounded-full object-cover border border-gray-700 bg-gray-900 hidden">
                <form onsubmit="uploadAvatar(event)" class="flex-1 flex gap-2 items-center">
                    <input id="avatar-file" type="file" accept="image/jpeg,image/png,image/webp"
                        class="flex-1 text-sm text-gray-300">
                    <button type="submit"
                        class="px-3 py-2 text-sm border border-gray-600 rounded-lg text-gray-300 hover:text-white hover:border-gray-400 transition">
                        Upload Avatar
                    </button>
                </form>
            </div>
            <form class="space-y-3" onsubmit="saveAccountProfile(event)">
                <input id="account-name" type="text" placeholder="Имя"
                    class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg focus:ring-2 focus:ring-teal-500 focus:outline-none">
                <div class="space-y-2">
                    <input id="account-email" type="email" placeholder="Email (опционально)"
                        class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg focus:ring-2 focus:ring-teal-500 focus:outline-none">
                    <div class="flex items-center justify-between text-xs">
                        <span id="account-email-status" class="text-yellow-300">Email: не подтверждено</span>
                        <button type="button" id="btn-verify-email" onclick="verifyEmailStub()"
                            class="px-2 py-1 border border-yellow-400/40 rounded text-yellow-200 hover:text-yellow-100 hover:border-yellow-300">
                            Подтвердить
                        </button>
                    </div>
                </div>
                <div class="space-y-2">
                    <input id="account-phone" type="tel" placeholder="Телефон (опционально)"
                        class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg focus:ring-2 focus:ring-teal-500 focus:outline-none">
                    <div class="flex items-center justify-between text-xs">
                        <span id="account-phone-status" class="text-yellow-300">Телефон: не подтверждено</span>
                        <button type="button" id="btn-verify-phone" onclick="verifyPhoneStub()"
                            class="px-2 py-1 border border-yellow-400/40 rounded text-yellow-200 hover:text-yellow-100 hover:border-yellow-300">
                            Подтвердить
                        </button>
                    </div>
                </div>
                <label class="flex items-start gap-2 text-sm text-gray-300">
                    <input id="account-share" type="checkbox" class="mt-1">
                    <span>Передавать эти данные в сторонние сервисы при OIDC входе.</span>
                </label>
                <button type="submit"
                    class="w-full py-2 bg-gradient-to-r from-teal-500 to-blue-600 rounded-lg font-semibold hover:from-teal-400 hover:to-blue-500 transition">
                    Сохранить профиль
                </button>
                <button type="button" onclick="handleDeleteAccount()"
                    class="w-full py-2 border border-red-500/40 rounded-lg font-semibold text-red-300 hover:text-red-200 hover:border-red-400 transition">
                    Удалить аккаунт и профиль
                </button>
            </form>
        </div>

        <div id="message" class="mt-4 text-center text-sm min-h-[20px]"></div>
        <button id="oidc-return-btn" onclick="resumeOidcReturn()"
            class="hidden mt-2 w-full py-2 text-sm border border-teal-500/40 rounded-lg text-teal-300 hover:text-teal-200 hover:border-teal-400 transition">
            Вернуться к клиенту
        </button>
        <button id="logout-btn" onclick="handleLogout()"
            class="hidden mt-3 w-full py-2 text-sm border border-red-500/40 rounded-lg text-red-300 hover:text-red-200 hover:border-red-400 transition">
            Logout
        </button>
    </div>

    <div id="profile-modal">
        <div class="bg-gray-800 p-6 rounded-2xl shadow-xl w-full max-w-md border border-gray-700">
            <h3 class="text-xl font-semibold mb-3">Профиль (опционально)</h3>
            <p class="text-sm text-gray-300 mb-4">
                Можно добавить имя, email и телефон. Эти данные будут передаваться в другие сервисы только при вашем согласии.
            </p>
            <form class="space-y-3" onsubmit="saveProfile(event)">
                <input id="profile-name" type="text" placeholder="Имя"
                    class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg focus:ring-2 focus:ring-teal-500 focus:outline-none">
                <input id="profile-email" type="email" placeholder="Email (опционально)"
                    class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg focus:ring-2 focus:ring-teal-500 focus:outline-none">
                <input id="profile-phone" type="tel" placeholder="Телефон (опционально)"
                    class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg focus:ring-2 focus:ring-teal-500 focus:outline-none">
                <label class="flex items-start gap-2 text-sm text-gray-300">
                    <input id="profile-share" type="checkbox" class="mt-1">
                    <span>Разрешаю передавать эти данные при входе на другие сервисы.</span>
                </label>
                <div class="flex gap-2 pt-1">
                    <button type="submit"
                        class="flex-1 py-2 bg-gradient-to-r from-teal-500 to-blue-600 rounded-lg font-semibold hover:from-teal-400 hover:to-blue-500 transition">
                        Сохранить
                    </button>
                    <button type="button" onclick="closeProfileModal()"
                        class="flex-1 py-2 border border-gray-600 rounded-lg font-semibold text-gray-300 hover:text-white hover:border-gray-400 transition">
                        Пропустить
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let pendingOidcReturn = null;

        function switchMode(mode) {
            const regFlow = document.getElementById('register-flow');
            const loginFlow = document.getElementById('login-flow');
            const tabReg = document.getElementById('tab-register');
            const tabLogin = document.getElementById('tab-login');
            const msg = document.getElementById('message');

            msg.innerText = ""; // clear messages

            if (mode === 'register') {
                regFlow.classList.remove('hidden');
                loginFlow.classList.add('hidden');
                tabReg.className = "flex-1 py-2 text-teal-400 border-b-2 border-teal-400 font-medium";
                tabLogin.className = "flex-1 py-2 text-gray-500 font-medium";
            } else {
                regFlow.classList.add('hidden');
                loginFlow.classList.remove('hidden');
                tabReg.className = "flex-1 py-2 text-gray-500 font-medium";
                tabLogin.className = "flex-1 py-2 text-blue-400 border-b-2 border-blue-400 font-medium";
            }
        }

        let conditionalAbort = null;
        let conditionalInFlight = false;

        async function handleRegister(e) {
            e.preventDefault();
            const email = "";
            showMessage("Requesting creation...", "text-yellow-400");
            if (conditionalAbort) {
                conditionalAbort.abort();
                conditionalAbort = null;
                conditionalInFlight = false;
            }

            try {
                const res = await registerUser(email);
                showMessage("Passkey created. You are logged in.", "text-green-400");
                applySessionState(true, res.display_name || res.email || "User");
                await loadProfileForAccountUI();
                if (res.manual_return_required && res.redirect) {
                    pendingOidcReturn = {
                        url: res.redirect,
                        host: (res.return_client_host || "client").trim()
                    };
                    renderOidcReturnButton();
                    showMessage("Профиль сохраните при желании, затем вернитесь в " + pendingOidcReturn.host, "text-green-400");
                } else {
                    pendingOidcReturn = null;
                    renderOidcReturnButton();
                }
            } catch (err) {
                console.error(err);
                showMessage("Error: " + err.message, "text-red-400");
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = "";
            const params = new URLSearchParams(window.location.search);
            const authRequestID = params.get("auth_request_id");
            showMessage("Requesting assertion...", "text-yellow-400");
            if (conditionalAbort) {
                conditionalAbort.abort();
                conditionalAbort = null;
                conditionalInFlight = false;
            }

            try {
                const res = await loginUser(email, authRequestID);
                showMessage("Logged in as " + res.email, "text-green-400");
                applySessionState(true, res.display_name || res.email || "User");
                if (res.redirect && res.redirect !== "/") {
                    window.location.href = res.redirect;
                    return;
                }
                const params = new URLSearchParams(window.location.search);
                const returnTo = params.get("return_to");
                if (returnTo) {
                    window.location.href = returnTo;
                    return;
                }
                await loadProfileForAccountUI();
            } catch (err) {
                console.error(err);
                showMessage("Error: " + err.message, "text-red-400");
            }
        }

        async function tryConditionalLogin() {
            const logoutVisible = !document.getElementById('logout-btn').classList.contains('hidden');
            if (logoutVisible) return;
            const params = new URLSearchParams(window.location.search);
            if (params.get("mode") === "register") return;

            if (!window.PublicKeyCredential || !PublicKeyCredential.isConditionalMediationAvailable) {
                return;
            }

            let conditionalAvailable = false;
            try {
                conditionalAvailable = await PublicKeyCredential.isConditionalMediationAvailable();
            } catch {
                conditionalAvailable = false;
            }
            if (!conditionalAvailable) {
                return;
            }

            try {
                if (conditionalInFlight) return;
                conditionalInFlight = true;
                conditionalAbort = new AbortController();

                // Fetch options for conditional login
                const beginRes = await fetch('/auth/login/begin');
                if (!beginRes.ok) {
                    conditionalInFlight = false;
                    return;
                }
                const options = await beginRes.json();
                options.publicKey.challenge = base64URLToBuffer(options.publicKey.challenge);
                if (options.publicKey.allowCredentials) {
                    options.publicKey.allowCredentials.forEach(cred => {
                        cred.id = base64URLToBuffer(cred.id);
                    });
                }

                const credential = await navigator.credentials.get({
                    publicKey: options.publicKey,
                    mediation: "conditional",
                    signal: conditionalAbort.signal,
                });

                if (!credential) {
                    conditionalInFlight = false;
                    return;
                }

                showMessage("Signing in...", "text-yellow-400");
                const res = await finishLoginWithCredential(credential, params.get("auth_request_id"));
                showMessage("Logged in as " + res.email, "text-green-400");
                conditionalInFlight = false;

                const returnTo = params.get("return_to");
                if (returnTo) {
                    window.location.href = returnTo;
                }
            } catch (err) {
                conditionalInFlight = false;
                // Ignore conditional errors; user can use manual login/register
            }
        }

        function showMessage(text, colorClass) {
            const msg = document.getElementById('message');
            msg.innerText = text;
            msg.className = "mt-4 text-center text-sm " + colorClass;
        }

        function renderOidcReturnButton() {
            const btn = document.getElementById('oidc-return-btn');
            if (!pendingOidcReturn || !pendingOidcReturn.url) {
                btn.classList.add('hidden');
                btn.innerText = "Вернуться к клиенту";
                return;
            }
            btn.innerText = "Вернуться на " + pendingOidcReturn.host;
            btn.classList.remove('hidden');
        }

        function resumeOidcReturn() {
            if (!pendingOidcReturn || !pendingOidcReturn.url) return;
            window.location.href = pendingOidcReturn.url;
        }

        function initializePendingOidcReturnFromQuery() {
            if (pendingOidcReturn && pendingOidcReturn.url) return;
            const params = new URLSearchParams(window.location.search);
            const returnTo = params.get("return_to");
            const authRequestID = params.get("auth_request_id");
            const clientHost = (params.get("client_host") || "client").trim();

            let url = "";
            if (returnTo) {
                url = returnTo;
            } else if (authRequestID) {
                url = "/authorize/callback?id=" + encodeURIComponent(authRequestID);
            }
            if (!url) return;

            pendingOidcReturn = { url, host: clientHost };
            renderOidcReturnButton();
        }

        async function handleLogout() {
            try {
                const res = await fetch('/auth/logout', { method: 'POST' });
                if (!res.ok) {
                    throw new Error(await res.text());
                }
                closeProfileModal();
                pendingOidcReturn = null;
                renderOidcReturnButton();
                applySessionState(false, "");
                showMessage("Logged out", "text-green-400");
                history.replaceState({}, "", "/");
            } catch (err) {
                showMessage("Logout error: " + err.message, "text-red-400");
            }
        }

        async function handleDeleteAccount() {
            const ok = window.confirm("Удалить аккаунт и профиль без возможности восстановления?");
            if (!ok) return;
            try {
                const res = await fetch('/auth/delete-account', { method: 'POST' });
                if (!res.ok) {
                    throw new Error(await res.text());
                }
                closeProfileModal();
                applySessionState(false, "");
                showMessage("Аккаунт удален.", "text-green-400");
                history.replaceState({}, "", "/");
            } catch (err) {
                showMessage("Delete error: " + err.message, "text-red-400");
            }
        }

        function applySessionState(authenticated, email) {
            const guestUI = document.getElementById('guest-ui');
            const accountUI = document.getElementById('account-ui');
            const logoutBtn = document.getElementById('logout-btn');
            if (authenticated) {
                guestUI.classList.add('hidden');
                accountUI.classList.remove('hidden');
                logoutBtn.classList.remove('hidden');
                showMessage("Session active: " + email, "text-green-400");
                return;
            }
            guestUI.classList.remove('hidden');
            accountUI.classList.add('hidden');
            logoutBtn.classList.add('hidden');
            pendingOidcReturn = null;
            renderOidcReturnButton();
        }

        async function loadSessionState() {
            try {
                const res = await fetch('/auth/session');
                if (!res.ok) return;
                const data = await res.json();
                const authenticated = Boolean(data.authenticated);
                applySessionState(authenticated, data.display_name || data.email || "");
                if (authenticated) {
                    initializePendingOidcReturnFromQuery();
                    populateAccountUI(data);
                    await loadProfileForAccountUI();
                }
            } catch (_) {
                applySessionState(false, "");
            }
        }

        function populateAccountUI(profile) {
            document.getElementById('account-name').value = profile.display_name || "";
            document.getElementById('account-email').value = profile.profile_email || profile.email || "";
            document.getElementById('account-phone').value = profile.phone || "";
            document.getElementById('account-share').checked = Boolean(profile.share_profile);
            setAvatar(profile.picture_url || "");
            renderVerificationStatus({
                email_verified: Boolean(profile.email_verified),
                phone_verified: Boolean(profile.phone_verified),
                email: profile.profile_email || profile.email || "",
                phone: profile.phone || ""
            });
        }

        function renderVerificationStatus(profile) {
            const emailVerified = Boolean(profile.email_verified);
            const phoneVerified = Boolean(profile.phone_verified);
            const emailHasValue = Boolean((profile.email || "").trim());
            const phoneHasValue = Boolean((profile.phone || "").trim());

            const emailStatus = document.getElementById('account-email-status');
            emailStatus.innerText = "Email: " + (emailVerified ? "подтверждено" : "не подтверждено");
            emailStatus.className = emailVerified ? "text-green-300" : "text-yellow-300";

            const phoneStatus = document.getElementById('account-phone-status');
            phoneStatus.innerText = "Телефон: " + (phoneVerified ? "подтверждено" : "не подтверждено");
            phoneStatus.className = phoneVerified ? "text-green-300" : "text-yellow-300";

            document.getElementById('btn-verify-email').classList.toggle('hidden', emailVerified || !emailHasValue);
            document.getElementById('btn-verify-phone').classList.toggle('hidden', phoneVerified || !phoneHasValue);
        }

        async function loadProfileForAccountUI() {
            try {
                const res = await fetch('/auth/profile');
                if (!res.ok) {
                    return;
                }
                const profile = await res.json();
                document.getElementById('account-name').value = profile.display_name || "";
                document.getElementById('account-email').value = profile.email || "";
                document.getElementById('account-phone').value = profile.phone || "";
                document.getElementById('account-share').checked = Boolean(profile.share_profile);
                setAvatar(profile.picture_url || "");
                renderVerificationStatus(profile);
            } catch (_) {
                // no-op
            }
        }

        function setAvatar(url) {
            const img = document.getElementById('account-avatar');
            if (url) {
                img.src = url;
                img.classList.remove('hidden');
                return;
            }
            img.src = "";
            img.classList.add('hidden');
        }

        async function uploadAvatar(e) {
            e.preventDefault();
            const input = document.getElementById('avatar-file');
            if (!input.files || !input.files[0]) {
                showMessage("Select an image first.", "text-yellow-400");
                return;
            }
            const form = new FormData();
            form.append('file', input.files[0]);
            try {
                const res = await fetch('/auth/avatar', { method: 'POST', body: form });
                if (!res.ok) {
                    throw new Error(await res.text());
                }
                const payload = await res.json();
                setAvatar(payload.picture_url || "");
                input.value = "";
                showMessage("Avatar updated.", "text-green-400");
            } catch (err) {
                showMessage("Avatar upload failed: " + err.message, "text-red-400");
            }
        }

        async function saveAccountProfile(e) {
            e.preventDefault();
            const payload = {
                display_name: document.getElementById('account-name').value.trim(),
                email: document.getElementById('account-email').value.trim(),
                phone: document.getElementById('account-phone').value.trim(),
                share_profile: document.getElementById('account-share').checked
            };
            try {
                const res = await fetch('/auth/profile', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) {
                    throw new Error(await res.text());
                }
                await loadProfileForAccountUI();
                applySessionState(true, payload.display_name || payload.email || "User");
                showMessage("Profile saved.", "text-green-400");
            } catch (err) {
                showMessage("Profile save failed: " + err.message, "text-red-400");
            }
        }

        function verifyEmailStub() {
            showMessage("Подтверждение email пока в разработке.", "text-yellow-400");
        }

        function verifyPhoneStub() {
            showMessage("Подтверждение телефона пока в разработке.", "text-yellow-400");
        }

        function openProfileModal(profile) {
            document.getElementById('profile-name').value = profile.display_name || "";
            document.getElementById('profile-email').value = profile.email || "";
            document.getElementById('profile-phone').value = profile.phone || "";
            document.getElementById('profile-share').checked = Boolean(profile.share_profile);
            document.getElementById('profile-modal').classList.add('open');
        }

        function closeProfileModal() {
            document.getElementById('profile-modal').classList.remove('open');
        }

        async function saveProfile(e) {
            e.preventDefault();
            const payload = {
                display_name: document.getElementById('profile-name').value.trim(),
                email: document.getElementById('profile-email').value.trim(),
                phone: document.getElementById('profile-phone').value.trim(),
                share_profile: document.getElementById('profile-share').checked
            };
            try {
                const res = await fetch('/auth/profile', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) {
                    throw new Error(await res.text());
                }
                closeProfileModal();
                showMessage("Profile saved.", "text-green-400");
                if (payload.display_name) {
                    applySessionState(true, payload.display_name);
                }
                if (pendingOidcReturn && pendingOidcReturn.url) {
                    showMessage("Профиль сохранен. Нажмите «Вернуться на " + pendingOidcReturn.host + "».", "text-green-400");
                }
            } catch (err) {
                showMessage("Profile save failed: " + err.message, "text-red-400");
            }
        }

        // Resolve session state first, then conditional login.
        loadSessionState().then(() => tryConditionalLogin());
    </script>
</body>

</html>
