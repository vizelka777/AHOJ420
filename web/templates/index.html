<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ahoj420 - Passkey Auth</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="/static/js/glue.js?v=20260226e"></script>
    <style>
        #profile-modal,
        #recovery-modal,
        #qr-login-modal,
        #delete-account-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.65);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
            z-index: 50;
        }
        #profile-modal.open,
        #recovery-modal.open,
        #qr-login-modal.open,
        #delete-account-modal.open {
            display: flex;
        }
    </style>
</head>

<body class="bg-gray-900 text-white min-h-screen py-4 flex items-start sm:items-center justify-center font-sans">

    <div class="bg-gray-800 p-8 rounded-2xl shadow-xl w-full max-w-md max-h-[calc(100vh-2rem)] overflow-y-auto border border-gray-700">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-teal-400 to-blue-500">
                Ahoj420
            </h1>
        </div>
        <button id="oidc-return-btn" onclick="resumeOidcReturn()"
            class="hidden -mt-4 mb-4 w-full py-2 text-sm border border-teal-500/40 rounded-lg text-teal-300 hover:text-teal-200 hover:border-teal-400 transition">
            Вернуться к клиенту
        </button>

        <div id="guest-ui">
            <!-- Tabs -->
            <div class="flex border-b border-gray-700 mb-6">
                <button onclick="switchMode('login')" id="tab-login"
                    class="flex-1 py-2 text-blue-400 border-b-2 border-blue-400 font-medium">Sign In</button>
                <button onclick="switchMode('register')" id="tab-register" class="flex-1 py-2 text-gray-500 font-medium">
                    Register</button>
            </div>

            <!-- Registration Form -->
            <div id="register-flow" class="hidden">
                <h2 class="text-xl font-semibold mb-4 text-center">Create Passkey</h2>
                <form class="space-y-4" onsubmit="handleRegister(event)">
                    <button type="submit"
                        class="w-full py-3 bg-gradient-to-r from-teal-500 to-blue-600 rounded-lg font-semibold hover:from-teal-400 hover:to-blue-500 transition shadow-lg shadow-teal-500/20">
                        Create Passkey
                    </button>
                </form>
            </div>

            <!-- Login Form -->
            <div id="login-flow">
                <h2 class="text-xl font-semibold mb-4 text-center">Welcome Back</h2>
                <form class="space-y-4" onsubmit="handleLogin(event)">
                    <button type="submit"
                        class="w-full py-3 bg-gradient-to-r from-blue-600 to-purple-600 rounded-lg font-semibold hover:from-blue-500 hover:to-purple-500 transition shadow-lg shadow-blue-500/20">
                        Sign In with Passkey
                    </button>
                </form>
            </div>

            <!-- Extra options -->
            <div class="mt-6 space-y-3">
                <button type="button" onclick="openQRLoginModal('login')"
                    class="w-full py-2 text-sm border border-teal-500/40 rounded-lg text-teal-200 hover:text-teal-100 hover:border-teal-300 transition">
                    Войти по QR
                </button>
                <button type="button" onclick="openRecoveryModal()"
                    class="w-full py-2 text-sm border border-amber-500/40 rounded-lg text-amber-200 hover:text-amber-100 hover:border-amber-300 transition">
                    Восстановить учет через email или телефон
                </button>
                <button type="button" onclick="openQRLoginModal('add_device')"
                    class="w-full py-2 text-sm border border-cyan-500/40 rounded-lg text-cyan-200 hover:text-cyan-100 hover:border-cyan-300 transition">
                    Add Device
                </button>
            </div>
            <div id="message-guest" class="mt-4 text-center text-sm min-h-[20px]"></div>
        </div>

        <div id="account-ui" class="hidden space-y-4">
            <h2 class="text-xl font-semibold text-center">Ahoj <span id="account-title-name">User</span></h2>
            <div id="recovery-passkey-panel" class="hidden p-3 border border-amber-500/40 rounded-lg bg-amber-500/10 text-amber-100 text-sm space-y-2">
                <div>Режим восстановления активен. Создайте новый passkey, чтобы заменить старые ключи.</div>
                <button id="btn-recovery-create-passkey" type="button" onclick="createRecoveryPasskey()"
                    class="w-full py-2 border border-amber-300/50 rounded-lg font-semibold text-amber-100 hover:text-white hover:border-amber-200 transition">
                    Создать новый passkey
                </button>
            </div>
            <div id="qr-approve-panel" class="hidden p-3 border border-teal-500/40 rounded-lg bg-teal-500/10 text-teal-100 text-sm space-y-2">
                <div>Обнаружен QR токен. Подтвердите вход на другом устройстве.</div>
                <div id="qr-approve-token" class="text-xs text-teal-200 break-all"></div>
                <button id="btn-qr-approve" type="button" onclick="approveScannedQR()"
                    class="w-full py-2 border border-teal-300/50 rounded-lg font-semibold text-teal-100 hover:text-white hover:border-teal-200 transition">
                    Подтвердить QR вход
                </button>
            </div>
            <div class="flex items-center gap-3">
                <img id="account-avatar" src="" alt="Avatar"
                    class="w-16 h-16 rounded-full object-cover border border-gray-700 bg-gray-900 hidden">
                <form onsubmit="uploadAvatar(event)" class="flex-1 flex gap-2 items-center">
                    <input id="avatar-file" type="file" accept="image/jpeg,image/png,image/webp" onchange="onAvatarFileSelected(event)"
                        class="hidden">
                    <label for="avatar-file" title="Выбрать файл"
                        class="w-10 h-10 inline-flex items-center justify-center rounded-lg border border-gray-600 text-gray-300 hover:text-white hover:border-gray-400 transition cursor-pointer">
                        <svg viewBox="0 0 24 24" class="w-5 h-5 fill-current" aria-hidden="true">
                            <path d="M4 6a2 2 0 0 1 2-2h3l2 2h7a2 2 0 0 1 2 2v2H4V6Zm0 5h16v7a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-7Zm8 2.5a2.5 2.5 0 1 0 .001 5.001A2.5 2.5 0 0 0 12 13.5Z"></path>
                        </svg>
                    </label>
                    <img id="avatar-file-preview" src="" alt="Preview"
                        class="hidden w-10 h-10 rounded-lg object-cover border border-gray-700 bg-gray-900">
                    <button type="submit"
                        title="Загрузить аватар"
                        class="w-10 h-10 inline-flex items-center justify-center rounded-lg border border-gray-600 text-gray-300 hover:text-white hover:border-gray-400 transition">
                        <svg viewBox="0 0 24 24" class="w-5 h-5 fill-current" aria-hidden="true">
                            <path d="M12 3 7 8h3v6h4V8h3l-5-5Zm-7 13h3v3h8v-3h3v5H5v-5Z"></path>
                        </svg>
                    </button>
                </form>
            </div>
            <form class="space-y-3" onsubmit="saveAccountProfile(event)">
                <input id="account-name" type="text" placeholder="Имя"
                    class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg focus:ring-2 focus:ring-teal-500 focus:outline-none">
                <div class="space-y-2">
                    <input id="account-email" type="email" placeholder="Email (опционально)"
                        class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg focus:ring-2 focus:ring-teal-500 focus:outline-none">
                    <div class="flex items-center justify-between text-xs">
                        <span id="account-email-status" class="text-yellow-300">Email: не подтверждено</span>
                        <button type="button" id="btn-verify-email" onclick="requestEmailVerification()"
                            class="px-2 py-1 border border-yellow-400/40 rounded text-yellow-200 hover:text-yellow-100 hover:border-yellow-300">
                            Подтвердить
                        </button>
                    </div>
                </div>
                <div class="space-y-2">
                    <input id="account-phone" type="tel" placeholder="Телефон (опционально)"
                        class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg focus:ring-2 focus:ring-teal-500 focus:outline-none">
                    <div class="flex items-center justify-between text-xs">
                        <span id="account-phone-status" class="text-yellow-300">Телефон: не подтверждено</span>
                        <button type="button" id="btn-verify-phone" onclick="verifyPhoneStub()"
                            class="px-2 py-1 border border-yellow-400/40 rounded text-yellow-200 hover:text-yellow-100 hover:border-yellow-300">
                            Подтвердить
                        </button>
                    </div>
                </div>
                <label class="invisible h-0 overflow-hidden flex items-start gap-2 text-sm text-gray-300">
                    <input id="account-share" type="checkbox" class="mt-1">
                    <span>Передавать эти данные в сторонние сервисы при OIDC входе.</span>
                </label>
                <button type="submit"
                    class="w-full py-2 bg-gradient-to-r from-teal-500 to-blue-600 rounded-lg font-semibold hover:from-teal-400 hover:to-blue-500 transition">
                    Сохранить профиль
                </button>
            </form>
            <div id="message-account" class="text-center text-sm min-h-[20px]"></div>
            <button id="logout-btn" onclick="handleLogout()"
                class="w-full py-2 text-sm border border-red-500/40 rounded-lg text-red-300 hover:text-red-200 hover:border-red-400 transition">
                Logout
            </button>
            <div id="device-sessions-panel" class="p-3 border border-gray-700 rounded-lg bg-gray-900/60 space-y-2">
                <div class="flex items-center justify-between">
                    <div class="text-sm font-semibold text-gray-100">Устройства и сессии</div>
                    <button type="button" onclick="loadDevicesForAccountUI()"
                        class="px-2 py-1 text-xs border border-gray-600 rounded text-gray-300 hover:text-white hover:border-gray-400 transition">
                        Обновить
                    </button>
                </div>
                <div id="device-sessions-list" class="max-h-56 overflow-y-auto pr-1 space-y-2 text-xs text-gray-300">
                    <div class="text-gray-400">Загрузка...</div>
                </div>
            </div>
            <div id="danger-zone" class="pt-2 border-t border-red-500/20">
                <button type="button" onclick="handleDeleteAccount()"
                    class="w-full py-2 bg-red-600 rounded-lg font-semibold text-white hover:bg-red-500 transition">
                    Удалить аккаунт и пользователя
                </button>
            </div>
        </div>

    </div>

    <div id="profile-modal">
        <div class="bg-gray-800 p-6 rounded-2xl shadow-xl w-full max-w-md border border-gray-700">
            <h3 class="text-xl font-semibold mb-3">Профиль (опционально)</h3>
            <p class="text-sm text-gray-300 mb-4">
                Можно добавить имя, email и телефон. Эти данные будут передаваться в другие сервисы только при вашем согласии.
            </p>
            <form class="space-y-3" onsubmit="saveProfile(event)">
                <input id="profile-name" type="text" placeholder="Имя"
                    class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg focus:ring-2 focus:ring-teal-500 focus:outline-none">
                <input id="profile-email" type="email" placeholder="Email (опционально)"
                    class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg focus:ring-2 focus:ring-teal-500 focus:outline-none">
                <input id="profile-phone" type="tel" placeholder="Телефон (опционально)"
                    class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg focus:ring-2 focus:ring-teal-500 focus:outline-none">
                <label class="flex items-start gap-2 text-sm text-gray-300">
                    <input id="profile-share" type="checkbox" class="mt-1">
                    <span>Разрешаю передавать эти данные при входе на другие сервисы.</span>
                </label>
                <div class="flex gap-2 pt-1">
                    <button type="submit"
                        class="flex-1 py-2 bg-gradient-to-r from-teal-500 to-blue-600 rounded-lg font-semibold hover:from-teal-400 hover:to-blue-500 transition">
                        Сохранить
                    </button>
                    <button type="button" onclick="closeProfileModal()"
                        class="flex-1 py-2 border border-gray-600 rounded-lg font-semibold text-gray-300 hover:text-white hover:border-gray-400 transition">
                        Пропустить
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="recovery-modal">
        <div class="bg-gray-800 p-6 rounded-2xl shadow-xl w-full max-w-md border border-gray-700">
            <h3 class="text-xl font-semibold mb-3">Восстановление учетной записи</h3>
            <p class="text-sm text-gray-300 mb-4">
                Укажите email или подтвержденный телефон.
                Для email придет ссылка, для телефона придет 6-значный SMS-код.
            </p>
            <form class="space-y-3" onsubmit="submitRecoveryRequest(event)">
                <input id="recovery-email" type="email" placeholder="Email"
                    class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg focus:ring-2 focus:ring-amber-500 focus:outline-none">
                <div class="text-center text-xs text-gray-400">или</div>
                <input id="recovery-phone" type="tel" placeholder="Телефон в формате +420777123456"
                    class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg focus:ring-2 focus:ring-amber-500 focus:outline-none">
                <div class="flex gap-2 pt-1">
                    <button id="btn-recovery-submit" type="submit"
                        class="flex-1 py-2 bg-gradient-to-r from-amber-500 to-orange-500 rounded-lg font-semibold hover:from-amber-400 hover:to-orange-400 transition">
                        Продолжить
                    </button>
                    <button type="button" onclick="closeRecoveryModal()"
                        class="flex-1 py-2 border border-gray-600 rounded-lg font-semibold text-gray-300 hover:text-white hover:border-gray-400 transition">
                        Закрыть
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="qr-login-modal">
        <div class="bg-gray-800 p-6 rounded-2xl shadow-xl w-full max-w-md border border-gray-700">
            <h3 id="qr-login-title" class="text-xl font-semibold mb-3">Вход по QR</h3>
            <p id="qr-login-description" class="text-sm text-gray-300 mb-4">
                Отсканируйте QR код авторизованным телефоном и подтвердите вход.
            </p>
            <div class="bg-white rounded-xl p-3 flex justify-center items-center mb-3 min-h-[244px]">
                <div id="qr-login-qrcode"></div>
            </div>
            <p id="qr-login-status" class="text-sm text-yellow-300 mb-2">Подготовка QR…</p>
            <p id="qr-login-url" class="text-xs text-gray-400 break-all mb-4"></p>
            <div class="flex gap-2">
                <button id="btn-qr-refresh" type="button" onclick="startQRLoginFlow()"
                    class="flex-1 py-2 bg-gradient-to-r from-teal-500 to-cyan-500 rounded-lg font-semibold hover:from-teal-400 hover:to-cyan-400 transition">
                    Обновить
                </button>
                <button type="button" onclick="closeQRLoginModal()"
                    class="flex-1 py-2 border border-gray-600 rounded-lg font-semibold text-gray-300 hover:text-white hover:border-gray-400 transition">
                    Закрыть
                </button>
            </div>
        </div>
    </div>

    <div id="delete-account-modal">
        <div class="bg-gray-800 p-6 rounded-2xl shadow-xl w-full max-w-md border border-red-500/30">
            <h3 class="text-xl font-semibold mb-3 text-red-300">Подтверждение удаления аккаунта</h3>
            <p class="text-sm text-gray-200 mb-3">
                После удаления доступ к этим клиентам будет потерян. Профили в этих клиентах будут анонимизированы через 1 месяц, затем полностью удалены.
            </p>
            <div id="delete-impact-list" class="max-h-48 overflow-auto p-3 rounded-lg border border-gray-700 bg-gray-900/70 text-xs text-gray-300 mb-4">
                Загрузка...
            </div>
            <div class="flex gap-2">
                <button type="button" onclick="closeDeleteAccountModal()"
                    class="flex-1 py-2 border border-gray-600 rounded-lg font-semibold text-gray-300 hover:text-white hover:border-gray-400 transition">
                    Отмена
                </button>
                <button id="btn-confirm-delete-account" type="button" onclick="confirmDeleteAccount()"
                    class="flex-1 py-2 bg-red-600 rounded-lg font-semibold text-white hover:bg-red-500 transition">
                    Подтвердить удаление
                </button>
            </div>
        </div>
    </div>

    <script>
        let pendingOidcReturn = null;
        let originalAccountProfile = null;
        let recoveryModeActive = false;
        let qrLoginPollTimer = null;
        let qrLoginPollInFlight = false;
        let qrLoginToken = "";
        let qrLoginAuthRequestID = "";
        let qrLoginPurpose = "login";
        let scannedQRToken = "";
        let addDeviceFlowStarted = false;

        function normalizeQRToken(raw) {
            const token = (raw || "").trim().toLowerCase();
            return /^[a-f0-9]{64}$/.test(token) ? token : "";
        }

        function refreshScannedQRToken() {
            const params = new URLSearchParams(window.location.search);
            scannedQRToken = normalizeQRToken(params.get("token"));
        }

        function switchMode(mode) {
            const regFlow = document.getElementById('register-flow');
            const loginFlow = document.getElementById('login-flow');
            const tabReg = document.getElementById('tab-register');
            const tabLogin = document.getElementById('tab-login');
            document.getElementById('message-guest').innerText = "";
            document.getElementById('message-account').innerText = "";

            if (mode === 'register') {
                regFlow.classList.remove('hidden');
                loginFlow.classList.add('hidden');
                tabReg.className = "flex-1 py-2 text-teal-400 border-b-2 border-teal-400 font-medium";
                tabLogin.className = "flex-1 py-2 text-gray-500 font-medium";
            } else {
                regFlow.classList.add('hidden');
                loginFlow.classList.remove('hidden');
                tabReg.className = "flex-1 py-2 text-gray-500 font-medium";
                tabLogin.className = "flex-1 py-2 text-blue-400 border-b-2 border-blue-400 font-medium";
            }
        }

        let conditionalAbort = null;
        let conditionalInFlight = false;

        async function handleRegister(e) {
            e.preventDefault();
            const email = "";
            showMessage("Requesting creation...", "text-yellow-400");
            if (conditionalAbort) {
                conditionalAbort.abort();
                conditionalAbort = null;
                conditionalInFlight = false;
            }

            try {
                const res = await registerUser(email);
                if (recoveryModeActive) {
                    showMessage("Новый passkey создан. Режим восстановления завершен.", "text-green-400");
                    recoveryModeActive = false;
                    renderRecoveryModeUI(false);
                } else {
                    showMessage("Passkey created. You are logged in.", "text-green-400");
                }
                applySessionState(true, res.display_name || res.email || "User");
                await loadProfileForAccountUI();
                await loadDevicesForAccountUI();
                if (res.manual_return_required && res.redirect) {
                    pendingOidcReturn = {
                        url: res.redirect,
                        host: (res.return_client_host || "client").trim()
                    };
                    renderOidcReturnButton();
                    showMessage("Профиль сохраните при желании, затем вернитесь в " + pendingOidcReturn.host, "text-green-400");
                } else {
                    pendingOidcReturn = null;
                    renderOidcReturnButton();
                }
            } catch (err) {
                console.error(err);
                showMessage("Error: " + err.message, "text-red-400");
            }
        }

        async function createRecoveryPasskey() {
            await handleRegister({ preventDefault() { } });
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = "";
            const params = new URLSearchParams(window.location.search);
            const authRequestID = params.get("auth_request_id");
            showMessage("Requesting assertion...", "text-yellow-400");
            if (conditionalAbort) {
                conditionalAbort.abort();
                conditionalAbort = null;
                conditionalInFlight = false;
            }

            try {
                const res = await loginUser(email, authRequestID);
                showMessage("Logged in as " + res.email, "text-green-400");
                applySessionState(true, res.display_name || res.email || "User");
                if (res.redirect && res.redirect !== "/") {
                    window.location.href = res.redirect;
                    return;
                }
                const params = new URLSearchParams(window.location.search);
                const returnTo = params.get("return_to");
                if (returnTo) {
                    window.location.href = returnTo;
                    return;
                }
                await loadProfileForAccountUI();
                await loadDevicesForAccountUI();
            } catch (err) {
                console.error(err);
                showMessage("Error: " + err.message, "text-red-400");
            }
        }

        async function tryConditionalLogin() {
            const accountVisible = !document.getElementById('account-ui').classList.contains('hidden');
            if (accountVisible) return;
            const params = new URLSearchParams(window.location.search);
            if (params.get("mode") === "register") return;

            if (!window.PublicKeyCredential || !PublicKeyCredential.isConditionalMediationAvailable) {
                return;
            }

            let conditionalAvailable = false;
            try {
                conditionalAvailable = await PublicKeyCredential.isConditionalMediationAvailable();
            } catch {
                conditionalAvailable = false;
            }
            if (!conditionalAvailable) {
                return;
            }

            try {
                if (conditionalInFlight) return;
                conditionalInFlight = true;
                conditionalAbort = new AbortController();

                // Fetch options for conditional login
                const beginRes = await fetch('/auth/login/begin');
                if (!beginRes.ok) {
                    conditionalInFlight = false;
                    return;
                }
                const options = await beginRes.json();
                options.publicKey.challenge = base64URLToBuffer(options.publicKey.challenge);
                if (options.publicKey.allowCredentials) {
                    options.publicKey.allowCredentials.forEach(cred => {
                        cred.id = base64URLToBuffer(cred.id);
                    });
                }

                const credential = await navigator.credentials.get({
                    publicKey: options.publicKey,
                    mediation: "conditional",
                    signal: conditionalAbort.signal,
                });

                if (!credential) {
                    conditionalInFlight = false;
                    return;
                }

                showMessage("Signing in...", "text-yellow-400");
                const res = await finishLoginWithCredential(credential, params.get("auth_request_id"));
                showMessage("Logged in as " + res.email, "text-green-400");
                conditionalInFlight = false;

                const returnTo = params.get("return_to");
                if (returnTo) {
                    window.location.href = returnTo;
                }
            } catch (err) {
                conditionalInFlight = false;
                // Ignore conditional errors; user can use manual login/register
            }
        }

        function showMessage(text, colorClass) {
            const accountVisible = !document.getElementById('account-ui').classList.contains('hidden');
            const msg = accountVisible ? document.getElementById('message-account') : document.getElementById('message-guest');
            msg.innerText = text;
            msg.className = "text-center text-sm min-h-[20px] " + colorClass;
        }

        function resolveSafeReturnURL(rawURL, clientHost) {
            const raw = (rawURL || "").trim();
            if (!raw) return "";
            const host = (clientHost || "").trim().toLowerCase();

            if (raw.startsWith("/")) {
                if (raw.startsWith("//")) return "";
                return raw;
            }

            try {
                const u = new URL(raw);
                if (u.protocol !== "https:") return "";
                if (host && u.host.toLowerCase() !== host) return "";
                return u.toString();
            } catch (_) {
                return "";
            }
        }

        function renderOidcReturnButton() {
            const btn = document.getElementById('oidc-return-btn');
            if (!pendingOidcReturn || !pendingOidcReturn.url) {
                btn.classList.add('hidden');
                btn.innerText = "Вернуться к клиенту";
                return;
            }
            btn.innerText = "Вернуться на " + pendingOidcReturn.host;
            btn.classList.remove('hidden');
        }

        function resumeOidcReturn() {
            if (!pendingOidcReturn || !pendingOidcReturn.url) return;
            window.location.href = pendingOidcReturn.url;
        }

        function initializePendingOidcReturnFromQuery() {
            if (pendingOidcReturn && pendingOidcReturn.url) return;
            const params = new URLSearchParams(window.location.search);
            const returnTo = params.get("return_to");
            const authRequestID = params.get("auth_request_id");
            const clientHost = (params.get("client_host") || "client").trim();
            const profileReturn = resolveSafeReturnURL(params.get("return_profile_to"), clientHost);
            const afterSaveReturn = resolveSafeReturnURL(params.get("return_after_save_to"), clientHost);

            let url = "";
            if (profileReturn) {
                url = profileReturn;
            } else if (returnTo) {
                url = returnTo;
            } else if (authRequestID) {
                url = "/authorize/callback?id=" + encodeURIComponent(authRequestID);
            }
            if (!url) return;

            pendingOidcReturn = { url, host: clientHost, afterSaveURL: afterSaveReturn };
            renderOidcReturnButton();
        }

        async function handleLogout() {
            try {
                const res = await fetch('/auth/logout', { method: 'POST' });
                if (!res.ok) {
                    throw new Error(await res.text());
                }
                closeProfileModal();
                closeRecoveryModal();
                closeQRLoginModal();
                closeDeleteAccountModal();
                pendingOidcReturn = null;
                renderOidcReturnButton();
                applySessionState(false, "");
                showMessage("Logged out", "text-green-400");
                history.replaceState({}, "", "/");
            } catch (err) {
                showMessage("Logout error: " + err.message, "text-red-400");
            }
        }

        async function handleDeleteAccount() {
            await openDeleteAccountModal();
        }

        function closeDeleteAccountModal() {
            document.getElementById('delete-account-modal').classList.remove('open');
        }

        function renderDeleteImpactClients(clients) {
            const list = document.getElementById('delete-impact-list');
            if (!Array.isArray(clients) || clients.length === 0) {
                list.innerHTML = '<div class="text-gray-400">Клиентские приложения не найдены.</div>';
                return;
            }
            const rows = clients.map((item) => {
                const host = (item.client_host || "").trim();
                const clientID = (item.client_id || "").trim();
                const label = host || clientID || "unknown client";
                const lastSeen = formatDateTime(item.last_seen_at || "");
                return `<div class="py-1 border-b border-gray-800 last:border-b-0">
                    <div class="text-red-200">${escapeHTML(label)}</div>
                    <div class="text-gray-500">client_id: ${escapeHTML(clientID || "n/a")}</div>
                    <div class="text-gray-500">последний вход: ${escapeHTML(lastSeen)}</div>
                </div>`;
            });
            list.innerHTML = rows.join("");
        }

        async function openDeleteAccountModal() {
            const list = document.getElementById('delete-impact-list');
            list.innerHTML = '<div class="text-gray-400">Загрузка...</div>';
            document.getElementById('delete-account-modal').classList.add('open');
            try {
                const impact = await getDeleteAccountImpact();
                renderDeleteImpactClients(impact.clients || []);
            } catch (err) {
                list.innerHTML = '<div class="text-red-400">Не удалось загрузить список клиентов: ' + escapeHTML(err.message) + '</div>';
            }
        }

        async function confirmDeleteAccount() {
            const btn = document.getElementById('btn-confirm-delete-account');
            btn.disabled = true;
            try {
                const res = await fetch('/auth/delete-account', { method: 'POST' });
                if (!res.ok) {
                    throw new Error(await res.text());
                }
                closeDeleteAccountModal();
                closeProfileModal();
                applySessionState(false, "");
                showMessage("Аккаунт удален.", "text-green-400");
                history.replaceState({}, "", "/");
            } catch (err) {
                showMessage("Delete error: " + err.message, "text-red-400");
            } finally {
                btn.disabled = false;
            }
        }

        function applySessionState(authenticated, email) {
            const guestUI = document.getElementById('guest-ui');
            const accountUI = document.getElementById('account-ui');
            if (authenticated) {
                guestUI.classList.add('hidden');
                accountUI.classList.remove('hidden');
                document.getElementById('account-title-name').innerText = (email || "User").trim() || "User";
                renderQRApprovePanel(true);
                loadDevicesForAccountUI();
                showMessage("Session active: " + email, "text-green-400");
                return;
            }
            renderRecoveryModeUI(false);
            renderQRApprovePanel(false);
            clearDeviceSessionsList();
            clearAvatarFileSelection();
            closeDeleteAccountModal();
            addDeviceFlowStarted = false;
            guestUI.classList.remove('hidden');
            accountUI.classList.add('hidden');
            pendingOidcReturn = null;
            renderOidcReturnButton();
        }

        function renderRecoveryModeUI(enabled) {
            recoveryModeActive = Boolean(enabled);
            const panel = document.getElementById('recovery-passkey-panel');
            if (recoveryModeActive) {
                panel.classList.remove('hidden');
            } else {
                panel.classList.add('hidden');
            }
        }

        function renderQRApprovePanel(authenticated) {
            const panel = document.getElementById('qr-approve-panel');
            const tokenEl = document.getElementById('qr-approve-token');
            if (authenticated && scannedQRToken) {
                tokenEl.innerText = "Token: " + scannedQRToken;
                panel.classList.remove('hidden');
                return;
            }
            tokenEl.innerText = "";
            panel.classList.add('hidden');
        }

        function clearDeviceSessionsList() {
            const list = document.getElementById('device-sessions-list');
            list.innerHTML = '<div class="text-gray-400">Нет данных.</div>';
        }

        function escapeHTML(raw) {
            return (raw || "")
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;")
                .replaceAll("\"", "&quot;")
                .replaceAll("'", "&#39;");
        }

        function formatDateTime(raw) {
            if (!raw) return "n/a";
            const dt = new Date(raw);
            if (Number.isNaN(dt.getTime())) return raw;
            return dt.toLocaleString();
        }

        function renderDeviceSessions(devices) {
            const list = document.getElementById('device-sessions-list');
            if (!Array.isArray(devices) || devices.length === 0) {
                list.innerHTML = '<div class="text-gray-400">Сессий пока нет.</div>';
                return;
            }

            const rows = devices.map((device) => {
                const statusBadge = device.current
                    ? '<span class="px-2 py-0.5 rounded border border-emerald-400/40 text-emerald-300">Текущее</span>'
                    : (device.active
                        ? '<span class="px-2 py-0.5 rounded border border-cyan-400/40 text-cyan-300">В сети</span>'
                        : '<span class="px-2 py-0.5 rounded border border-gray-600 text-gray-400">Не в сети</span>');
                const encodedSessionID = encodeURIComponent((device.session_id || "").trim());
                const logoutBtn = device.active && encodedSessionID
                    ? `<button type="button" onclick="logoutDeviceSessionUI('${encodedSessionID}')"
                        class="px-2 py-1 rounded text-[11px] border border-pink-500/50 text-pink-300 hover:text-pink-200 hover:border-pink-400 transition">Выйти</button>`
                    : "";
                return `
                    <div class="p-2 rounded border border-gray-700 bg-gray-900/80 space-y-1">
                        <div class="flex items-center justify-between gap-2">
                            <div class="text-gray-100 text-sm">${escapeHTML(device.device || "Unknown device")}</div>
                            <div class="flex items-center gap-2">${statusBadge}${logoutBtn}</div>
                        </div>
                        <div class="text-gray-400">Последняя активность: ${escapeHTML(formatDateTime(device.last_seen_at))}</div>
                        <div class="text-gray-500">Создана: ${escapeHTML(formatDateTime(device.created_at))}</div>
                        <div class="text-gray-500 break-all">${escapeHTML(device.ip || "IP n/a")}</div>
                    </div>
                `;
            });
            list.innerHTML = rows.join("");
        }

        async function loadDevicesForAccountUI() {
            const list = document.getElementById('device-sessions-list');
            list.innerHTML = '<div class="text-gray-400">Загрузка...</div>';
            try {
                const payload = await getDeviceSessions();
                renderDeviceSessions(payload.devices || []);
            } catch (_) {
                list.innerHTML = '<div class="text-red-400">Не удалось загрузить устройства.</div>';
            }
        }

        async function logoutDeviceSessionUI(encodedSessionID) {
            let sessionID = "";
            try {
                sessionID = decodeURIComponent((encodedSessionID || "").trim());
            } catch (_) {
                sessionID = (encodedSessionID || "").trim();
            }
            if (!sessionID) {
                showMessage("Не удалось определить сессию.", "text-yellow-400");
                return;
            }

            try {
                const payload = await logoutDeviceSession({ session_id: sessionID });
                if (payload.current_logged_out) {
                    closeProfileModal();
                    closeRecoveryModal();
                    closeQRLoginModal();
                    pendingOidcReturn = null;
                    renderOidcReturnButton();
                    applySessionState(false, "");
                    showMessage("Вы вышли из текущей сессии.", "text-green-400");
                    history.replaceState({}, "", "/");
                    return;
                }
                await loadDevicesForAccountUI();
                showMessage("Сессия устройства завершена.", "text-green-400");
            } catch (err) {
                showMessage("Не удалось завершить сессию: " + err.message, "text-red-400");
            }
        }

        async function loadSessionState() {
            refreshScannedQRToken();
            try {
                const res = await fetch('/auth/session');
                if (!res.ok) return;
                const data = await res.json();
                const authenticated = Boolean(data.authenticated);
                applySessionState(authenticated, data.display_name || data.email || "");
                if (authenticated) {
                    renderRecoveryModeUI(Boolean(data.recovery_mode));
                    if (Boolean(data.recovery_mode)) {
                        showMessage("Режим восстановления: создайте новый passkey.", "text-amber-300");
                    }
                    initializePendingOidcReturnFromQuery();
                    populateAccountUI(data);
                    await loadProfileForAccountUI();
                    await loadDevicesForAccountUI();
                    await maybeStartAddDeviceFlow(true);
                } else if (scannedQRToken) {
                    showMessage("Сначала войдите на этом устройстве, затем подтвердите QR вход.", "text-yellow-300");
                }
            } catch (_) {
                applySessionState(false, "");
            }
        }

        async function maybeStartAddDeviceFlow(authenticated) {
            const params = new URLSearchParams(window.location.search);
            if ((params.get("mode") || "").trim() !== "add-device") {
                return;
            }
            if (!authenticated) {
                showMessage("Подтвердите QR на основном устройстве для добавления passkey.", "text-cyan-300");
                return;
            }
            if (recoveryModeActive) {
                showMessage("Завершите восстановление, затем добавьте устройство.", "text-amber-300");
                return;
            }
            if (addDeviceFlowStarted) {
                return;
            }

            addDeviceFlowStarted = true;
            showMessage("Подтвердите создание passkey для этого устройства...", "text-cyan-300");
            try {
                const payload = await registerUser("");
                applySessionState(true, payload.display_name || payload.email || "User");
                await loadProfileForAccountUI();
                await loadDevicesForAccountUI();
                showMessage("Новое устройство добавлено.", "text-green-400");

                params.delete("mode");
                const qs = params.toString();
                history.replaceState({}, "", qs ? "/?" + qs : "/");
            } catch (err) {
                addDeviceFlowStarted = false;
                showMessage("Не удалось добавить устройство: " + err.message, "text-red-400");
            }
        }

        function populateAccountUI(profile) {
            document.getElementById('account-title-name').innerText = ((profile.display_name || profile.email || "User").trim() || "User");
            document.getElementById('account-name').value = profile.display_name || "";
            document.getElementById('account-email').value = profile.profile_email || profile.email || "";
            document.getElementById('account-phone').value = profile.phone || "";
            document.getElementById('account-share').checked = Boolean(profile.share_profile);
            originalAccountProfile = {
                display_name: (profile.display_name || "").trim(),
                email: (profile.profile_email || profile.email || "").trim(),
                phone: (profile.phone || "").trim(),
                share_profile: Boolean(profile.share_profile),
            };
            setAvatar(profile.picture_url || "");
            renderVerificationStatus({
                email_verified: Boolean(profile.email_verified),
                phone_verified: Boolean(profile.phone_verified),
                email: profile.profile_email || profile.email || "",
                phone: profile.phone || ""
            });
        }

        function renderVerificationStatus(profile) {
            const emailVerified = Boolean(profile.email_verified);
            const phoneVerified = Boolean(profile.phone_verified);
            const emailHasValue = Boolean((profile.email || "").trim());
            const phoneHasValue = Boolean((profile.phone || "").trim());

            const emailStatus = document.getElementById('account-email-status');
            emailStatus.innerText = "Email: " + (emailVerified ? "подтверждено" : "не подтверждено");
            emailStatus.className = emailVerified ? "text-green-300" : "text-yellow-300";

            const phoneStatus = document.getElementById('account-phone-status');
            phoneStatus.innerText = "Телефон: " + (phoneVerified ? "подтверждено" : "не подтверждено");
            phoneStatus.className = phoneVerified ? "text-green-300" : "text-yellow-300";

            document.getElementById('btn-verify-email').classList.toggle('hidden', emailVerified || !emailHasValue);
            document.getElementById('btn-verify-phone').classList.toggle('hidden', phoneVerified || !phoneHasValue);
        }

        async function loadProfileForAccountUI() {
            try {
                const res = await fetch('/auth/profile');
                if (!res.ok) {
                    return;
                }
                const profile = await res.json();
                document.getElementById('account-title-name').innerText = ((profile.display_name || profile.email || "User").trim() || "User");
                document.getElementById('account-name').value = profile.display_name || "";
                document.getElementById('account-email').value = profile.email || "";
                document.getElementById('account-phone').value = profile.phone || "";
                document.getElementById('account-share').checked = Boolean(profile.share_profile);
                originalAccountProfile = {
                    display_name: (profile.display_name || "").trim(),
                    email: (profile.email || "").trim(),
                    phone: (profile.phone || "").trim(),
                    share_profile: Boolean(profile.share_profile),
                };
                setAvatar(profile.picture_url || "");
                renderVerificationStatus(profile);
            } catch (_) {
                // no-op
            }
        }

        function collectAccountPayload() {
            return {
                display_name: document.getElementById('account-name').value.trim(),
                email: document.getElementById('account-email').value.trim(),
                phone: document.getElementById('account-phone').value.trim(),
                share_profile: document.getElementById('account-share').checked
            };
        }

        function accountProfileChanged(payload) {
            if (!originalAccountProfile) return true;
            return payload.display_name !== originalAccountProfile.display_name ||
                payload.email !== originalAccountProfile.email ||
                payload.phone !== originalAccountProfile.phone ||
                payload.share_profile !== originalAccountProfile.share_profile;
        }

        function setAvatar(url) {
            const img = document.getElementById('account-avatar');
            if (url) {
                img.src = url;
                img.classList.remove('hidden');
                return;
            }
            img.src = "";
            img.classList.add('hidden');
        }

        function onAvatarFileSelected(e) {
            const input = e && e.target ? e.target : document.getElementById('avatar-file');
            const preview = document.getElementById('avatar-file-preview');
            if (!input || !input.files || !input.files[0]) {
                preview.src = "";
                preview.classList.add('hidden');
                return;
            }
            const reader = new FileReader();
            reader.onload = () => {
                preview.src = String(reader.result || "");
                preview.classList.remove('hidden');
            };
            reader.readAsDataURL(input.files[0]);
        }

        function clearAvatarFileSelection() {
            const input = document.getElementById('avatar-file');
            const preview = document.getElementById('avatar-file-preview');
            input.value = "";
            preview.src = "";
            preview.classList.add('hidden');
        }

        async function uploadAvatar(e) {
            e.preventDefault();
            const input = document.getElementById('avatar-file');
            if (!input.files || !input.files[0]) {
                showMessage("Select an image first.", "text-yellow-400");
                return;
            }
            const form = new FormData();
            form.append('file', input.files[0]);
            try {
                const res = await fetch('/auth/avatar', { method: 'POST', body: form });
                if (!res.ok) {
                    throw new Error(await res.text());
                }
                const payload = await res.json();
                setAvatar(payload.picture_url || "");
                clearAvatarFileSelection();
                showMessage("Avatar updated.", "text-green-400");
            } catch (err) {
                showMessage("Avatar upload failed: " + err.message, "text-red-400");
            }
        }

        async function saveAccountProfile(e) {
            e.preventDefault();
            const payload = collectAccountPayload();
            const changed = accountProfileChanged(payload);

            try {
                if (changed) {
                    const res = await fetch('/auth/profile', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!res.ok) {
                        throw new Error(await res.text());
                    }
                    await loadProfileForAccountUI();
                    applySessionState(true, payload.display_name || payload.email || "User");
                    showMessage("Profile saved.", "text-green-400");
                }
                if (pendingOidcReturn && pendingOidcReturn.afterSaveURL) {
                    window.location.href = pendingOidcReturn.afterSaveURL;
                    return;
                }
                if (!changed) {
                    showMessage("No profile changes.", "text-yellow-400");
                }
            } catch (err) {
                showMessage("Profile save failed: " + err.message, "text-red-400");
            }
        }

        async function requestEmailVerification() {
            const btn = document.getElementById('btn-verify-email');
            btn.disabled = true;
            try {
                const res = await fetch('/auth/profile/email/request-verify', { method: 'POST' });
                const contentType = (res.headers.get('content-type') || "").toLowerCase();
                let message = "";
                if (contentType.includes('application/json')) {
                    const data = await res.json();
                    message = data.message || "";
                } else {
                    message = await res.text();
                }
                if (!res.ok) {
                    if (res.status === 404) {
                        showMessage("Сервер пока не поддерживает endpoint подтверждения email.", "text-yellow-400");
                        return;
                    }
                    throw new Error(message || ("HTTP " + res.status));
                }
                showMessage(message || "Ссылка подтверждения отправлена.", "text-green-400");
            } catch (err) {
                showMessage("Не удалось отправить письмо подтверждения: " + err.message, "text-red-400");
            } finally {
                btn.disabled = false;
            }
        }

        async function verifyPhoneStub() {
            const btn = document.getElementById('btn-verify-phone');
            btn.disabled = true;
            try {
                const sendRes = await fetch('/auth/profile/phone/request-verify', { method: 'POST' });
                const sendText = await sendRes.text();
                if (!sendRes.ok) {
                    throw new Error(sendText || ("HTTP " + sendRes.status));
                }

                const code = (window.prompt("Введите 6-значный код из SMS:") || "").trim();
                if (!code) {
                    showMessage("Код не введен.", "text-yellow-400");
                    return;
                }

                const verifyRes = await fetch('/auth/profile/phone/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: code })
                });
                const verifyText = await verifyRes.text();
                if (!verifyRes.ok) {
                    throw new Error(verifyText || ("HTTP " + verifyRes.status));
                }

                await loadProfileForAccountUI();
                showMessage("Телефон подтвержден.", "text-green-400");
            } catch (err) {
                showMessage("Не удалось подтвердить телефон: " + err.message, "text-red-400");
            } finally {
                btn.disabled = false;
            }
        }

        function setQRLoginStatus(text, colorClass) {
            const el = document.getElementById('qr-login-status');
            el.innerText = text;
            el.className = "text-sm mb-2 " + colorClass;
        }

        function stopQRLoginPolling() {
            if (qrLoginPollTimer) {
                clearInterval(qrLoginPollTimer);
                qrLoginPollTimer = null;
            }
            qrLoginPollInFlight = false;
        }

        function openQRLoginModal(purpose) {
            qrLoginPurpose = ((purpose || "login").trim().toLowerCase() === "add_device") ? "add_device" : "login";
            const title = document.getElementById('qr-login-title');
            const description = document.getElementById('qr-login-description');
            if (qrLoginPurpose === "add_device") {
                title.innerText = "Добавление устройства по QR";
                description.innerText = "Отсканируйте код авторизованным телефоном, чтобы подтвердить добавление устройства.";
            } else {
                title.innerText = "Вход по QR";
                description.innerText = "Отсканируйте QR код авторизованным телефоном и подтвердите вход.";
            }
            document.getElementById('qr-login-modal').classList.add('open');
            startQRLoginFlow();
        }

        function closeQRLoginModal() {
            stopQRLoginPolling();
            qrLoginToken = "";
            qrLoginAuthRequestID = "";
            qrLoginPurpose = "login";
            document.getElementById('qr-login-modal').classList.remove('open');
        }

        async function startQRLoginFlow() {
            stopQRLoginPolling();
            qrLoginToken = "";

            const btn = document.getElementById('btn-qr-refresh');
            const urlEl = document.getElementById('qr-login-url');
            const qrBox = document.getElementById('qr-login-qrcode');
            btn.disabled = true;
            urlEl.innerText = "";
            qrBox.innerHTML = "";
            setQRLoginStatus("Генерируем QR код...", "text-yellow-300");

            try {
                const payload = await generateQRLogin({ purpose: qrLoginPurpose });
                qrLoginToken = payload.token;
                const params = new URLSearchParams(window.location.search);
                qrLoginAuthRequestID = (params.get("auth_request_id") || "").trim();
                urlEl.innerText = payload.qr_url || "";

                if (window.QRCode && typeof window.QRCode === "function") {
                    new window.QRCode(qrBox, {
                        text: payload.qr_url,
                        width: 220,
                        height: 220,
                        colorDark: "#0f172a",
                        colorLight: "#ffffff",
                        correctLevel: window.QRCode.CorrectLevel.M,
                    });
                } else {
                    qrBox.innerHTML = '<div class="text-xs text-gray-700 font-mono">QR unavailable</div>';
                }

                if (qrLoginPurpose === "add_device") {
                    setQRLoginStatus("Ожидание подтверждения добавления устройства...", "text-cyan-300");
                } else {
                    setQRLoginStatus("Ожидание подтверждения на телефоне...", "text-teal-300");
                }
                qrLoginPollTimer = setInterval(pollQRLoginStatus, 2000);
                await pollQRLoginStatus();
            } catch (err) {
                setQRLoginStatus("Не удалось запустить QR вход: " + err.message, "text-red-400");
            } finally {
                btn.disabled = false;
            }
        }

        async function pollQRLoginStatus() {
            if (!qrLoginToken || qrLoginPollInFlight) {
                return;
            }
            qrLoginPollInFlight = true;
            try {
                const data = await getQRLoginStatus(qrLoginToken, qrLoginAuthRequestID);
                if (data.status === "pending") {
                    return;
                }
                if (data.status === "approved") {
                    stopQRLoginPolling();
                    setQRLoginStatus("Подтверждено. Переход...", "text-green-400");
                    window.location.href = data.redirect || "/";
                    return;
                }
                if (data.status === "expired") {
                    stopQRLoginPolling();
                    setQRLoginStatus("QR код истек. Нажмите «Обновить».", "text-yellow-300");
                    return;
                }
                stopQRLoginPolling();
                setQRLoginStatus("Неожиданный статус QR входа.", "text-red-400");
            } catch (err) {
                setQRLoginStatus("Ошибка проверки QR: " + err.message, "text-red-400");
            } finally {
                qrLoginPollInFlight = false;
            }
        }

        async function approveScannedQR() {
            if (!scannedQRToken) {
                showMessage("QR токен не найден в URL.", "text-yellow-400");
                return;
            }

            const btn = document.getElementById('btn-qr-approve');
            btn.disabled = true;
            try {
                const res = await approveQRLogin({ token: scannedQRToken });
                showMessage(res.message || "QR вход подтвержден.", "text-green-400");
                scannedQRToken = "";
                const params = new URLSearchParams(window.location.search);
                params.delete("token");
                const qs = params.toString();
                history.replaceState({}, "", qs ? "/?" + qs : "/");
                renderQRApprovePanel(true);
            } catch (err) {
                showMessage("Не удалось подтвердить QR: " + err.message, "text-red-400");
            } finally {
                btn.disabled = false;
            }
        }

        function openRecoveryModal() {
            document.getElementById('recovery-email').value = "";
            document.getElementById('recovery-phone').value = "";
            document.getElementById('recovery-modal').classList.add('open');
        }

        function closeRecoveryModal() {
            document.getElementById('recovery-modal').classList.remove('open');
        }

        async function submitRecoveryRequest(e) {
            e.preventDefault();
            const email = document.getElementById('recovery-email').value.trim();
            const phone = document.getElementById('recovery-phone').value.trim();

            if ((!email && !phone) || (email && phone)) {
                showMessage("Укажите либо email, либо телефон.", "text-yellow-400");
                return;
            }

            const btn = document.getElementById('btn-recovery-submit');
            btn.disabled = true;

            try {
                const message = await requestRecovery({ email, phone });
                if (phone) {
                    const code = (window.prompt("Введите 6-значный код из SMS для восстановления:") || "").trim();
                    if (!code) {
                        showMessage("Код не введен.", "text-yellow-400");
                        return;
                    }
                    const verification = await verifyRecoveryCode({ phone, code });
                    closeRecoveryModal();
                    showMessage(verification.message || message || "Код подтвержден.", "text-green-400");
                    window.location.href = verification.redirect || "/?mode=recovery";
                    return;
                }
                closeRecoveryModal();
                showMessage(message || "Если учетная запись существует, сообщение отправлено.", "text-green-400");
            } catch (err) {
                showMessage("Не удалось отправить восстановление: " + err.message, "text-red-400");
            } finally {
                btn.disabled = false;
            }
        }

        function openProfileModal(profile) {
            document.getElementById('profile-name').value = profile.display_name || "";
            document.getElementById('profile-email').value = profile.email || "";
            document.getElementById('profile-phone').value = profile.phone || "";
            document.getElementById('profile-share').checked = Boolean(profile.share_profile);
            document.getElementById('profile-modal').classList.add('open');
        }

        function closeProfileModal() {
            document.getElementById('profile-modal').classList.remove('open');
        }

        async function saveProfile(e) {
            e.preventDefault();
            const payload = {
                display_name: document.getElementById('profile-name').value.trim(),
                email: document.getElementById('profile-email').value.trim(),
                phone: document.getElementById('profile-phone').value.trim(),
                share_profile: document.getElementById('profile-share').checked
            };
            try {
                const res = await fetch('/auth/profile', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) {
                    throw new Error(await res.text());
                }
                closeProfileModal();
                showMessage("Profile saved.", "text-green-400");
                if (payload.display_name) {
                    applySessionState(true, payload.display_name);
                }
                if (pendingOidcReturn && pendingOidcReturn.url) {
                    showMessage("Профиль сохранен. Нажмите «Вернуться на " + pendingOidcReturn.host + "».", "text-green-400");
                }
            } catch (err) {
                showMessage("Profile save failed: " + err.message, "text-red-400");
            }
        }

        // Resolve session state first, then conditional login.
        loadSessionState().then(() => tryConditionalLogin());
    </script>
</body>

</html>
